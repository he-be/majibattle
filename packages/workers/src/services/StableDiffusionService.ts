/**
 * Stable Diffusion APIé€£æºã‚µãƒ¼ãƒ“ã‚¹
 * Cloudflare TunnelçµŒç”±ã§ãƒ›ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã®Stable Diffusion WebUIã¨é€šä¿¡
 */

import { ImagePrompt } from './ImagePromptGenerationService';

export interface GeneratedImage {
  imageUrl: string;
  prompt: string;
  seed: number;
  generationTime: number;
}

export interface StableDiffusionResponse {
  images: string[]; // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿
  parameters: {
    seed: number;
    prompt: string;
    negative_prompt: string;
    width: number;
    height: number;
    steps: number;
    cfg_scale: number;
  };
  info: string;
}

export class StableDiffusionService {
  private apiEndpoint: string;
  private cfClientId?: string;
  private cfSecret?: string;

  constructor(apiEndpoint: string, cfClientId?: string, cfSecret?: string) {
    this.apiEndpoint = apiEndpoint;
    this.cfClientId = cfClientId;
    this.cfSecret = cfSecret;
  }

  /**
   * ç”»åƒã‚’ç”Ÿæˆ
   */
  async generateImage(imagePrompt: ImagePrompt): Promise<GeneratedImage> {
    const startTime = Date.now();

    try {
      console.log('ğŸ¨ Starting image generation...');
      console.log('Prompt:', imagePrompt.prompt);
      console.log('Negative:', imagePrompt.negativePrompt);

      const response = await this.callStableDiffusionAPI(imagePrompt);

      if (!response.images || response.images.length === 0) {
        throw new Error('No images generated by Stable Diffusion API');
      }

      // Base64ç”»åƒã‚’Blobã«å¤‰æ›ã—ã¦URLã‚’ç”Ÿæˆ
      const imageBase64 = response.images[0];
      const imageUrl = await this.convertBase64ToDataUrl(imageBase64);

      const generationTime = Date.now() - startTime;

      console.log('âœ… Image generation completed in', generationTime, 'ms');

      return {
        imageUrl,
        prompt: response.parameters.prompt,
        seed: response.parameters.seed,
        generationTime,
      };
    } catch (error) {
      console.error('âŒ Image generation failed:', error);
      throw new Error(
        `Image generation failed: ${error instanceof Error ? error.message : 'Unknown error'}`
      );
    }
  }

  /**
   * Stable Diffusion WebUI APIã‚’å‘¼ã³å‡ºã—
   */
  private async callStableDiffusionAPI(imagePrompt: ImagePrompt): Promise<StableDiffusionResponse> {
    // SDXLå›ºå®šè¨­å®šã‚’ä½¿ç”¨ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£
    const requestBody = {
      prompt: imagePrompt.prompt,
      negative_prompt: imagePrompt.negativePrompt,
      width: imagePrompt.width,
      height: imagePrompt.height,
      steps: imagePrompt.steps,
      cfg_scale: imagePrompt.cfgScale,
      seed: imagePrompt.seed,
      sampler_name: imagePrompt.samplerName,
      restore_faces: false,
      tiling: false,
      do_not_save_samples: true,
      do_not_save_grid: true,
      n_iter: 1,
      batch_size: 1,
      eta: 0,
      denoising_strength: 0.75,
      s_min_uncond: 0,
      s_churn: 0,
      s_tmax: 0,
      s_tmin: 0,
      s_noise: 1,
      override_settings: imagePrompt.checkpoint
        ? {
            sd_model_checkpoint: imagePrompt.checkpoint,
          }
        : {},
      override_settings_restore_afterwards: true,
      script_args: [],
      script_name: null,
      send_images: true,
      save_images: false,
      alwayson_scripts: {},
    };

    console.log('ğŸŒ Calling Stable Diffusion API:', this.apiEndpoint);

    const headers: Record<string, string> = {
      'Content-Type': 'application/json',
      Accept: 'application/json',
    };

    // Cloudflare Service Authç”¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ 
    if (this.cfClientId && this.cfSecret) {
      headers['CF-Access-Client-Id'] = this.cfClientId;
      headers['CF-Access-Client-Secret'] = this.cfSecret;
    }

    const response = await fetch(`${this.apiEndpoint}/sdapi/v1/txt2img`, {
      method: 'POST',
      headers,
      body: JSON.stringify(requestBody),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('âŒ Stable Diffusion API Error:', {
        status: response.status,
        statusText: response.statusText,
        body: errorText,
      });
      throw new Error(`Stable Diffusion API error: ${response.status} ${response.statusText}`);
    }

    const result = (await response.json()) as StableDiffusionResponse;

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
    if (!result.images || !Array.isArray(result.images)) {
      console.error('âŒ Invalid API response:', result);
      throw new Error('Invalid response from Stable Diffusion API');
    }

    return result;
  }

  /**
   * Base64æ–‡å­—åˆ—ã‚’Data URLã«å¤‰æ›
   */
  private async convertBase64ToDataUrl(base64: string): Promise<string> {
    try {
      // Base64ãƒ‡ãƒ¼ã‚¿ã«MIMEã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ ã—ã¦Data URLã‚’ä½œæˆ
      return `data:image/png;base64,${base64}`;
    } catch (error) {
      console.error('âŒ Failed to convert base64 to data URL:', error);
      throw new Error('Failed to process generated image');
    }
  }

  /**
   * APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
   */
  async testConnection(): Promise<boolean> {
    try {
      console.log('ğŸ” Testing Stable Diffusion API connection...');

      const headers: Record<string, string> = {
        Accept: 'application/json',
      };

      if (this.cfClientId && this.cfSecret) {
        headers['CF-Access-Client-Id'] = this.cfClientId;
        headers['CF-Access-Client-Secret'] = this.cfSecret;
      }

      // WebUI APIã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ†ã‚¹ãƒˆ
      const response = await fetch(`${this.apiEndpoint}/sdapi/v1/options`, {
        method: 'GET',
        headers,
      });

      if (response.ok) {
        console.log('âœ… Stable Diffusion API connection successful');
        return true;
      } else {
        console.error(
          'âŒ Stable Diffusion API connection failed:',
          response.status,
          response.statusText
        );
        return false;
      }
    } catch (error) {
      console.error('âŒ Stable Diffusion API connection test failed:', error);
      return false;
    }
  }

  /**
   * åˆ©ç”¨å¯èƒ½ãªã‚µãƒ³ãƒ—ãƒ©ãƒ¼ä¸€è¦§ã‚’å–å¾—
   */
  async getSamplers(): Promise<string[]> {
    try {
      const headers: Record<string, string> = {
        Accept: 'application/json',
      };

      if (this.cfClientId && this.cfSecret) {
        headers['CF-Access-Client-Id'] = this.cfClientId;
        headers['CF-Access-Client-Secret'] = this.cfSecret;
      }

      const response = await fetch(`${this.apiEndpoint}/sdapi/v1/samplers`, {
        method: 'GET',
        headers,
      });

      if (response.ok) {
        const samplers = (await response.json()) as Array<{ name: string }>;
        return samplers.map((s) => s.name);
      } else {
        console.warn('âš ï¸ Failed to fetch samplers, using default list');
        return ['Euler', 'Euler a', 'DPM++ 2M', 'DPM++ SDE'];
      }
    } catch (error) {
      console.warn('âš ï¸ Failed to fetch samplers:', error);
      return ['Euler', 'Euler a', 'DPM++ 2M', 'DPM++ SDE'];
    }
  }
}
